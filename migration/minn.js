!function(){function t(t,n){return t-n}function n(t,n){for(i=0;i<t.options.length;i++)if(t.options[i].value==n){t.options[i].disabled=!0;break}}function r(t,n){for(i=0;i<t.options.length;i++)if(t.options[i].value==n){t.options[i].selected=!0;break}}function e(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}d3.scale.t().range([0,300]).domain([-1,1]);var o=d3.scale.i(),a=d3.u.o().scale(850).translate([600,480/1.55]),c=d3.u.path().l(a);d3.select(".direction.mg_dropdown").style({left:"115px",top:"15px"}),d3.select(".category.mg_dropdown").style({left:"190px",top:"15px"}),d3.select(".type.mg_dropdown").style({left:"44px",top:"15px"}),direction=["Direction","Inflow","Outflow","Netflow"];for(ix in direction)d3.select(".direction.mg_dropdown").h("option").text(direction[ix]).s("value",direction[ix]);category=["Category","All","Flows by Employment"],category=category.concat(["In labor force, employed civilian","In labor force, unemployed","In labor force, in Armed Forces","Not in labor force"]),category=category.concat("Flows by Work Statues"),category=category.concat(["Worked 50 to 52 weeks in the past 12 months and usually worked 35 or more hours per week","Worked 50 to 52 weeks in the past 12 months and usually worked less than 35 hours per week","Worked 1 to 49 weeks in the past 12 months and usually worked 35 or more hours per week"," Worked 1 to 49 weeks in the past 12 months and usually worked less than 35 hours per week","Last worked 1 to 5 years ago","Last worked over 5 years ago or never worked"]),category=category.concat("Flows by Occupation"),category=category.concat(["Management, business, science, and arts occupations","Service occupations","Sales and office occupations","Natural resources, construction, and maintenance occupations","Production, transportation, and material moving occupations","Military specific occupations"]);for(ix in category)d3.select(".category.mg_dropdown").h("option").text(category[ix]).s("value",category[ix]);type=["Type","Number","Rate"];for(ix in type)d3.select(".type.mg_dropdown").h("option").text(type[ix]).s("value",type[ix]);n(document.getElementById("direction"),direction[0]),n(document.getElementById("type"),type[0]);for(x in category)0!=x&&2!=x&&7!=x&&14!=x||n(document.getElementById("category"),category[x]);var u=d3.select("#div1").h("svg:svg").s("width",1640).s("height",760).append("svg:g").s("id","states");d3.json("us-states.json",function(n){u.M("path").data(n.p).g().append("svg:path").s("fill","#fff").s("stroke","#ccc").s("d",c),d3.v("airports.csv",function(n){d3.v("new-flights-airport.csv",function(i){function d(t,r,o,a,d,f,l){var s=t._;current_value_dict=function(t,n,r,e){var i={};if("in"===n.substring(3))var o=n.substring(0,3)+"dto";else o="out"===n.substring(3)?n.substring(0,3)+"otd":n.substring(0,3)+"onet";for(ix in t)t[ix].origin===e&&(i[t[ix].destination]=t[ix][o]/t[ix][r]);return i}(i,o,a,t._);var g=[];for(ix in current_value_dict)g.push(current_value_dict[ix]);if("in"===o.substring(3)){o.substring(0,3);var M=d3.scale.t().domain([Math.min.apply(Math,g),Math.max.apply(Math,g)]).range(["#f7f7f7",W[0]])}else if("out"===o.substring(3))o.substring(0,3),M=d3.scale.t().domain([Math.min.apply(Math,g),Math.max.apply(Math,g)]).range(["#f7f7f7",W[1]]);else o.substring(0,3),M=d3.scale.t().domain([Math.min.apply(Math,g),0,Math.max.apply(Math,g)]).range([W[1],"#f7f7f7",W[0]]);z.transition().duration(500).s("fill",function(t,n){return t._!=s?M(current_value_dict[t._]):l(t[o]/t[a])}).s("x",function(t,n){return t._!=s?"net"!==o.substring(3)||current_value_dict[t._]>=0?d:d+current_value_dict[t._]/f*length:"net"!==o.substring(3)||t[o]>=0?d:d+t[o]/t[a]/f*length}).s("width",function(t,n){return t._!=s?Math.abs(current_value_dict[t._])/f*length:Math.abs(t[o]/t[a])/f*length}),N.transition().duration(500).s("x",function(t,n){return t._!=s?current_value_dict[t._]>0?d+5+current_value_dict[t._]/f*length:d-5+current_value_dict[t._]/f*length:t[o]>0?d+5+t[o]/t[a]/f*length:d-5+t[o]/t[a]/f*length}).text(function(t,n){return t._!=s?2==h?Math.round(1e5*current_value_dict[t._])/100+"‰":e(current_value_dict[t._]):2==h?Math.round(t[o]/t[a]*1e5)/100+"‰":e(t[o]/t[a])}).s("text-anchor",function(t,n){return t._!=s?current_value_dict[t._]>=0?"start":"end":t[o]>=0?"start":"end"}),C.transition().duration(500).s("r",function(t){return t._!=s?2==h?2e3*Math.sqrt(Math.abs(current_value_dict[t._]))/18:Math.sqrt(Math.abs(current_value_dict[t._]))/18:2==h?2e3*Math.sqrt(Math.abs(t[o]/t[a]))/18:Math.sqrt(Math.abs(t[o]/t[a]))/18}).s("fill",function(t){return t._!=s?M(current_value_dict[t._]):l(t[o]/t[a])}),function(t,n,r,e,i,o,a,d){try{d3.M(".arc").remove()}catch(t){console.log("err")}var f={},l=[],s=d3.u.k().source(function(t){return"True"===t.m?f[t.target]:f[t.source]}).target(function(t){return"True"===t.m?f[t.source]:f[t.target]});t.forEach(function(t){var n=[+t.longitude,+t.latitude];f[t._]=n}),n.forEach(function(t){if(a.indexOf("in")>0)l.push({source:t.origin,target:t.destination,m:"True"});else if(a.indexOf("out")>0)l.push({source:t.origin,target:t.destination,m:"False"});else if(a.indexOf("net")>0){var n=a.substring(0,3)+"onet";t[n]>=0?l.push({source:t.origin,target:t.destination,m:"True"}):l.push({source:t.origin,target:t.destination,m:"False"})}}),u.M("path.arc").data(l).g().append("svg:path").s("class","arc").s("stroke","white").s("id",function(t){return"arc"+t.source}).s("visibility","hidden").s("d",function(t,n){return c(s(t))}),d3.M(".arc").transition().s("visibility","hidden"),d3.M("#arc"+o._).s("stroke-width",function(t,n){return 2==h?2e3*Math.sqrt(Math.abs(r[t.target]))/9:Math.sqrt(Math.abs(r[t.target]))/9}).s("stroke",function(t,n){return e(r[t.target])}).s("visibility","visible").call(D),d3.select("circle."+o._).F()}(n,i,current_value_dict,M,0,t,o)}u.append("text").s("class","name").s("x",920).s("y",604).s("fill","#3F3F3F").style("font-size",20).s("text-anchor","end").style("font-weight","bold").text("MSAs");var f=["nothing","in","out","net"],l=["nothing","all","nothing","em1","em2","em3","em4","nothing","ws1","ws2","ws3","ws4","ws5","ws6","nothing","oc1","oc2","oc3","oc4","oc5","oc6"];if("nothing"!=l[1]&&"nothing"!=f[1])var s=l[1]+f[1];var h=1,g=1,M=1,y=1==h?"numberpopulation":"ratepopulation",p=[],v=[],_=[],w=[],k=[];new_id_list=[],n.forEach(function(t,n){w.push(t.B),_.push(t[s]/t[y]),k.push(t._)}),o.domain(k),o.S([-50,550],.5,0);var x=_.slice(0);_.sort(t),_.reverse();for(var m=0;m<50;m++)for(var b=0;b<50;b++)x[b]===_[m]&&(p.push(w[b]),new_id_list.push(k[b]));v=_.slice(0);if("in"===s.substring(3))var F=s.substring(0,3)+"dto";if("out"===s.substring(3))F=s.substring(0,3)+"otd";var B=[],S=[];n.forEach(function(t){B.push(t[s]/t[y])}),i.forEach(function(t){S.push(t[F]/t[y])});var T=Math.max.apply(Math,B);length=240,data_min=Math.min.apply(Math,v),data_max=Math.max.apply(Math,v);var W=["#4FB3CF","#FDB924"],A=d3.scale.t().domain([Math.min.apply(Math,v),Math.max.apply(Math,v)]).range(["#f7f7f7",W[1]]),I=u.M("bar_label").data(n).g().append("text").s("class",function(t,n){return"mg_bar "+t._}).s("fill","#3F3F3F").s("x",975).s("y",function(t,n){return 60+o(t._)}).style("font-size",10).text(function(t,n){return w[n]}).T("click",function(t,n){d(t,0,s,y,1085,T,A)}).style("cursor","pointer"),N=u.M("bra_number").data(n).g().append("text").s("class",function(t,n){return"mg_bar "+t._}).s("fill","#3F3F3F").s("x",function(t,n){return 1085}).s("text-anchor","start").s("y",function(t){return 60+o(t._)}).style("font-size",10).text("0").T("click",function(t,n){d(t,0,s,y,1085,T,A)}).style("cursor","pointer"),z=u.M("bar").data(n).g().append("rect").s("class",function(t,n){return"mg_bar "+t._}).s("stroke","darkgray").s("fill","white").s("x",1085).s("y",function(t,n){return 52+o(t._)}).s("width",0).s("height",9).T("click",function(t,n){d(t,0,s,y,1085,T,A)}).style("cursor","pointer"),C=u.M("circle").data(n).g().append("circle").s("class",function(t,n){return"mg_bar "+t._}).style("stroke","darkgray").s("cx",function(t,n){return a([t.longitude,t.latitude])[0]}).s("cy",function(t,n){return a([t.longitude,t.latitude])[1]}).s("r",0).s("fill","white").style("cursor","pointer").T("click",function(t,n){d(t,0,s,y,1085,T,A)});o.domain(new_id_list),I.transition().duration(500).s("y",function(t,n){return 60+o(t._)}),N.transition().duration(500).s("x",function(t,n){return 1090+t[s]/t[y]/T*length}).text(function(t,n){return e(t[s]/t[y])}).s("y",function(t,n){return 60+o(t._)}),z.transition().duration(500).s("fill",function(t,n){return A(t[s]/t[y])}).s("y",function(t,n){return 52+o(t._)}).s("width",function(t,n){return t[s]/t[y]/T*length}),C.transition().s("r",function(t){return Math.sqrt(t[s]/t[y])/18}).s("fill",function(t){return A(t[s]/t[y])}),d3.M(".mg_bar").T("mouseover",function(t){d3.select("circle."+t._).F(),d3.select("circle."+t._).transition().style("stroke","red").style("stroke-width",2),d3.M("text."+t._).transition().s("fill","red").style("stroke","red").style("stroke-width",1),d3.M("rect."+t._).transition().style("stroke","red").style("stroke-width",2),d3.M("text.name").transition().text(t.name).s("fill","red")}).T("mouseout",function(t){d3.select("circle."+t._).transition().style("stroke","darkgrey").style("stroke-width",1),d3.M("text."+t._).transition().s("fill","#3F3F3F").style("stroke","none"),d3.M("rect."+t._).transition().style("stroke","darkgrey").style("stroke-width",1),d3.M("text.name").transition().text("MSAs").s("fill","#3F3F3F")}),d3.M(".mg_dropdown").T("change",function(){var r=d3.select(this).s("class").split(" ")[0];"type"==r?h=type.indexOf(d3.select(this)[0][0].value):"category"==r?M=category.indexOf(d3.select(this)[0][0].value):"direction"==r&&(g=direction.indexOf(d3.select(this)[0][0].value)),function(r,a,c){d3.M(".arc").transition().s("visibility","hidden");var u=l[c]+f[a],s=1==r?"numberpopulation":"ratepopulation",h=[],g=[],M=[],y=[],p=[];new_id_list=[],n.forEach(function(t,n){y.push(t.B),M.push(t[u]/t[s]),p.push(t._)}),o.domain(p),o.S([-50,550],.5,0);var v=M.slice(0);M.sort(t),M.reverse();for(var _=0;_<50;_++)for(var w=0;w<50;w++)v[w]===M[_]&&(h.push(y[w]),new_id_list.push(p[w]));g=M.slice(0);var k=0,x=["#4FB3CF","#FDB924"],m=[],b=[];if(n.forEach(function(t){m.push(t[u]/t[s])}),i.forEach(function(t){b.push(t[F]/t[s])}),"in"===u.substring(3)){var F=u.substring(0,3)+"dto",B=d3.scale.t().domain([Math.min.apply(Math,g),Math.max.apply(Math,g)]).range(["#f7f7f7",x[1]]),S=Math.max.apply(Math,m);k=1085}else"out"===u.substring(3)?(F=u.substring(0,3)+"otd",B=d3.scale.t().domain([Math.min.apply(Math,g),Math.max.apply(Math,g)]).range(["#f7f7f7",x[0]]),S=Math.max.apply(Math,m),k=1085):(F=u.substring(0,3)+"onet",B=d3.scale.t().domain([Math.min.apply(Math,g),0,Math.max.apply(Math,g)]).range([x[0],"#f7f7f7",x[1]]),S=Math.max.apply(Math,m)+Math.abs(Math.min.apply(Math,m)),k=1110+Math.abs(Math.min.apply(Math,m))/S*210,length=210);o.domain(new_id_list),I.transition().duration(500).s("y",function(t,n){return 60+o(t._)}),I.T("click",function(t,n){d(t,0,u,s,k,S,B)}),z.T("click",function(t,n){d(t,0,u,s,k,S,B)}),N.T("click",function(t,n){d(t,0,u,s,k,S,B)}),C.T("click",function(t,n){d(t,0,u,s,k,S,B)}),C.transition().s("r",function(t){return 2==r?2e3*Math.sqrt(Math.abs(t[u]/t[s]))/18:Math.sqrt(Math.abs(t[u]/t[s]))/18}).s("fill",function(t){return B(t[u]/t[s])}),z.transition().duration(500).s("fill",function(t,n){return B(t[u]/t[s])}).s("x",function(t,n){return t[u]>=0?k:k-Math.abs(t[u]/t[s])/S*length}).s("width",function(t,n){return Math.abs(t[u]/t[s])/S*length}).s("y",function(t,n){return 52+o(t._)}),N.transition().duration(500).s("x",function(t,n){return t[u]>=0?k+5+t[u]/t[s]/S*length:k-5+t[u]/t[s]/S*length}).text(function(t,n){return 2==r?Math.round(t[u]/t[s]*1e5)/100+"‰":e(t[u]/t[s])}).s("text-anchor",function(t,n){return t[u]>=0?"start":"end"}).s("y",function(t,n){return 60+o(t._)})}(h,g,M)}),r(document.getElementById("direction"),direction[1]),r(document.getElementById("type"),type[1]),r(document.getElementById("category"),category[1]);var D=function(t){t.transition().duration(function(t,n){return 500}).A("stroke-dasharray",L).W("end",function(t,n){})},L=function(){var t=this.getTotalLength();return d3.I("0,"+t,t+","+t)}})})}),d3.selection.prototype.F=function(){return this.W(function(){this.parentNode.appendChild(this)})}}();