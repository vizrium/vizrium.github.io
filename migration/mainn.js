!function(){function compareNumbers(t,e){return t-e}function setDisabledIndex(t,e){for(i=0;i<t.options.length;i++)if(t.options[i].value==e){t.options[i].disabled=!0;break}}function setSelectedIndex(t,e){for(i=0;i<t.options.length;i++)if(t.options[i].value==e){t.options[i].selected=!0;break}}function toCommas(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}d3.scale.linear().range([0,300]).domain([-1,1]);var t=d3.scale.ordinal(),e=d3.geo.albers().scale(850).translate([600,480/1.55]),a=d3.geo.path().projection(e);d3.select(".direction.mg_dropdown").style({left:"115px",top:"15px"}),d3.select(".category.mg_dropdown").style({left:"190px",top:"15px"}),d3.select(".type.mg_dropdown").style({left:"44px",top:"15px"}),direction=["Direction","Inflow","Outflow","Netflow"];for(ix in direction)d3.select(".direction.mg_dropdown").insert("option").text(direction[ix]).attr("value",direction[ix]);category=["Category","All","Flows by Employment"],category=category.concat(["In labor force, employed civilian","In labor force, unemployed","In labor force, in Armed Forces","Not in labor force"]),category=category.concat("Flows by Work Statues"),category=category.concat(["Worked 50 to 52 weeks in the past 12 months and usually worked 35 or more hours per week","Worked 50 to 52 weeks in the past 12 months and usually worked less than 35 hours per week","Worked 1 to 49 weeks in the past 12 months and usually worked 35 or more hours per week"," Worked 1 to 49 weeks in the past 12 months and usually worked less than 35 hours per week","Last worked 1 to 5 years ago","Last worked over 5 years ago or never worked"]),category=category.concat("Flows by Occupation"),category=category.concat(["Management, business, science, and arts occupations","Service occupations","Sales and office occupations","Natural resources, construction, and maintenance occupations","Production, transportation, and material moving occupations","Military specific occupations"]);for(ix in category)d3.select(".category.mg_dropdown").insert("option").text(category[ix]).attr("value",category[ix]);type=["Type","Number","Rate"];for(ix in type)d3.select(".type.mg_dropdown").insert("option").text(type[ix]).attr("value",type[ix]);setDisabledIndex(document.getElementById("direction"),direction[0]),setDisabledIndex(document.getElementById("type"),type[0]);for(x in category)0!=x&&2!=x&&7!=x&&14!=x||setDisabledIndex(document.getElementById("category"),category[x]);var n=d3.select("#div1").insert("svg:svg").attr("width",1640).attr("height",760).append("svg:g").attr("id","states");d3.json("us-states.json",function(r){n.selectAll("path").data(r.features).enter().append("svg:path").attr("fill","#fff").attr("stroke","#ccc").attr("d",a),d3.csv("airports.csv",function(r){d3.csv("new-flights-airport.csv",function(i){function triggertransition(t,e,o,s,c,u,d){var h=t.iata;current_value_dict=function getvaluelist(t,e,a,n){var r={};if("in"===e.substring(3))var i=e.substring(0,3)+"dto";else i="out"===e.substring(3)?e.substring(0,3)+"otd":e.substring(0,3)+"onet";for(ix in t)t[ix].origin===n&&(r[t[ix].destination]=t[ix][i]/t[ix][a]);return r}(i,o,s,t.iata);var f=[];for(ix in current_value_dict)f.push(current_value_dict[ix]);if("in"===o.substring(3)){o.substring(0,3);var g=d3.scale.linear().domain([Math.min.apply(Math,f),Math.max.apply(Math,f)]).range(["#f7f7f7",F[0]])}else if("out"===o.substring(3))o.substring(0,3),g=d3.scale.linear().domain([Math.min.apply(Math,f),Math.max.apply(Math,f)]).range(["#f7f7f7",F[1]]);else o.substring(0,3),g=d3.scale.linear().domain([Math.min.apply(Math,f),0,Math.max.apply(Math,f)]).range([F[1],"#f7f7f7",F[0]]);B.transition().duration(500).attr("fill",function(t,e){return t.iata!=h?g(current_value_dict[t.iata]):d(t[o]/t[s])}).attr("x",function(t,e){return t.iata!=h?"net"!==o.substring(3)||current_value_dict[t.iata]>=0?c:c+current_value_dict[t.iata]/u*length:"net"!==o.substring(3)||t[o]>=0?c:c+t[o]/t[s]/u*length}).attr("width",function(t,e){return t.iata!=h?Math.abs(current_value_dict[t.iata])/u*length:Math.abs(t[o]/t[s])/u*length}),E.transition().duration(500).attr("x",function(t,e){return t.iata!=h?current_value_dict[t.iata]>0?c+5+current_value_dict[t.iata]/u*length:c-5+current_value_dict[t.iata]/u*length:t[o]>0?c+5+t[o]/t[s]/u*length:c-5+t[o]/t[s]/u*length}).text(function(t,e){return t.iata!=h?2==l?Math.round(1e5*current_value_dict[t.iata])/100+"‰":toCommas(current_value_dict[t.iata]):2==l?Math.round(t[o]/t[s]*1e5)/100+"‰":toCommas(t[o]/t[s])}).attr("text-anchor",function(t,e){return t.iata!=h?current_value_dict[t.iata]>=0?"start":"end":t[o]>=0?"start":"end"}),S.transition().duration(500).attr("r",function(t){return t.iata!=h?2==l?2e3*Math.sqrt(Math.abs(current_value_dict[t.iata]))/18:Math.sqrt(Math.abs(current_value_dict[t.iata]))/18:2==l?2e3*Math.sqrt(Math.abs(t[o]/t[s]))/18:Math.sqrt(Math.abs(t[o]/t[s]))/18}).attr("fill",function(t){return t.iata!=h?g(current_value_dict[t.iata]):d(t[o]/t[s])}),function buildArc(t,e,r,i,o,s,c,u){try{d3.selectAll(".arc").remove()}catch(t){console.log("err")}var d={},h=[],f=d3.geo.greatArc().source(function(t){return"True"===t.flag?d[t.target]:d[t.source]}).target(function(t){return"True"===t.flag?d[t.source]:d[t.target]});t.forEach(function(t){var e=[+t.longitude,+t.latitude];d[t.iata]=e}),e.forEach(function(t){if(c.indexOf("in")>0)h.push({source:t.origin,target:t.destination,flag:"True"});else if(c.indexOf("out")>0)h.push({source:t.origin,target:t.destination,flag:"False"});else if(c.indexOf("net")>0){var e=c.substring(0,3)+"onet";t[e]>=0?h.push({source:t.origin,target:t.destination,flag:"True"}):h.push({source:t.origin,target:t.destination,flag:"False"})}}),n.selectAll("path.arc").data(h).enter().append("svg:path").attr("class","arc").attr("stroke","white").attr("id",function(t){return"arc"+t.source}).attr("visibility","hidden").attr("d",function(t,e){return a(f(t))}),d3.selectAll(".arc").transition().attr("visibility","hidden"),d3.selectAll("#arc"+s.iata).attr("stroke-width",function(t,e){return 2==l?2e3*Math.sqrt(Math.abs(r[t.target]))/9:Math.sqrt(Math.abs(r[t.target]))/9}).attr("stroke",function(t,e){return i(r[t.target])}).attr("visibility","visible").call(T),d3.select("circle."+s.iata).moveToFront()}(r,i,current_value_dict,g,0,t,o)}n.append("text").attr("class","name").attr("x",920).attr("y",604).attr("fill","#3F3F3F").style("font-size",20).attr("text-anchor","end").style("font-weight","bold").text("MSAs");var o=["nothing","in","out","net"],s=["nothing","all","nothing","em1","em2","em3","em4","nothing","ws1","ws2","ws3","ws4","ws5","ws6","nothing","oc1","oc2","oc3","oc4","oc5","oc6"];if("nothing"!=s[1]&&"nothing"!=o[1])var c=s[1]+o[1];var l=1,u=1,d=1,h=1==l?"numberpopulation":"ratepopulation",f=[],g=[],p=[],y=[],m=[];new_id_list=[],r.forEach(function(t,e){y.push(t.shortname),p.push(t[c]/t[h]),m.push(t.iata)}),t.domain(m),t.rangeBands([-50,550],.5,0);var x=p.slice(0);p.sort(compareNumbers),p.reverse();for(var v=0;v<50;v++)for(var b=0;b<50;b++)x[b]===p[v]&&(f.push(y[b]),new_id_list.push(m[b]));g=p.slice(0);if("in"===c.substring(3))var M=c.substring(0,3)+"dto";if("out"===c.substring(3))M=c.substring(0,3)+"otd";var _=[],w=[];r.forEach(function(t){_.push(t[c]/t[h])}),i.forEach(function(t){w.push(t[M]/t[h])});var k=Math.max.apply(Math,_);length=240,data_min=Math.min.apply(Math,g),data_max=Math.max.apply(Math,g);var F=["#4FB3CF","#FDB924"],A=d3.scale.linear().domain([Math.min.apply(Math,g),Math.max.apply(Math,g)]).range(["#f7f7f7",F[1]]),I=n.selectAll("bar_label").data(r).enter().append("text").attr("class",function(t,e){return"mg_bar "+t.iata}).attr("fill","#3F3F3F").attr("x",975).attr("y",function(e,a){return 60+t(e.iata)}).style("font-size",10).text(function(t,e){return y[e]}).on("click",function(t,e){triggertransition(t,0,c,h,1085,k,A)}).style("cursor","pointer"),E=n.selectAll("bra_number").data(r).enter().append("text").attr("class",function(t,e){return"mg_bar "+t.iata}).attr("fill","#3F3F3F").attr("x",function(t,e){return 1085}).attr("text-anchor","start").attr("y",function(e){return 60+t(e.iata)}).style("font-size",10).text("0").on("click",function(t,e){triggertransition(t,0,c,h,1085,k,A)}).style("cursor","pointer"),B=n.selectAll("bar").data(r).enter().append("rect").attr("class",function(t,e){return"mg_bar "+t.iata}).attr("stroke","darkgray").attr("fill","white").attr("x",1085).attr("y",function(e,a){return 52+t(e.iata)}).attr("width",0).attr("height",9).on("click",function(t,e){triggertransition(t,0,c,h,1085,k,A)}).style("cursor","pointer"),S=n.selectAll("circle").data(r).enter().append("circle").attr("class",function(t,e){return"mg_bar "+t.iata}).style("stroke","darkgray").attr("cx",function(t,a){return e([t.longitude,t.latitude])[0]}).attr("cy",function(t,a){return e([t.longitude,t.latitude])[1]}).attr("r",0).attr("fill","white").style("cursor","pointer").on("click",function(t,e){triggertransition(t,0,c,h,1085,k,A)});t.domain(new_id_list),I.transition().duration(500).attr("y",function(e,a){return 60+t(e.iata)}),E.transition().duration(500).attr("x",function(t,e){return 1090+t[c]/t[h]/k*length}).text(function(t,e){return toCommas(t[c]/t[h])}).attr("y",function(e,a){return 60+t(e.iata)}),B.transition().duration(500).attr("fill",function(t,e){return A(t[c]/t[h])}).attr("y",function(e,a){return 52+t(e.iata)}).attr("width",function(t,e){return t[c]/t[h]/k*length}),S.transition().attr("r",function(t){return Math.sqrt(t[c]/t[h])/18}).attr("fill",function(t){return A(t[c]/t[h])}),d3.selectAll(".mg_bar").on("mouseover",function(t){d3.select("circle."+t.iata).moveToFront(),d3.select("circle."+t.iata).transition().style("stroke","red").style("stroke-width",2),d3.selectAll("text."+t.iata).transition().attr("fill","red").style("stroke","red").style("stroke-width",1),d3.selectAll("rect."+t.iata).transition().style("stroke","red").style("stroke-width",2),d3.selectAll("text.name").transition().text(t.name).attr("fill","red")}).on("mouseout",function(t){d3.select("circle."+t.iata).transition().style("stroke","darkgrey").style("stroke-width",1),d3.selectAll("text."+t.iata).transition().attr("fill","#3F3F3F").style("stroke","none"),d3.selectAll("rect."+t.iata).transition().style("stroke","darkgrey").style("stroke-width",1),d3.selectAll("text.name").transition().text("MSAs").attr("fill","#3F3F3F")}),d3.selectAll(".mg_dropdown").on("change",function(){var e=d3.select(this).attr("class").split(" ")[0];"type"==e?l=type.indexOf(d3.select(this)[0][0].value):"category"==e?d=category.indexOf(d3.select(this)[0][0].value):"direction"==e&&(u=direction.indexOf(d3.select(this)[0][0].value)),function update(e,a,n){d3.selectAll(".arc").transition().attr("visibility","hidden");var c=s[n]+o[a],l=1==e?"numberpopulation":"ratepopulation",u=[],d=[],h=[],f=[],g=[];new_id_list=[],r.forEach(function(t,e){f.push(t.shortname),h.push(t[c]/t[l]),g.push(t.iata)}),t.domain(g),t.rangeBands([-50,550],.5,0);var p=h.slice(0);h.sort(compareNumbers),h.reverse();for(var y=0;y<50;y++)for(var m=0;m<50;m++)p[m]===h[y]&&(u.push(f[m]),new_id_list.push(g[m]));d=h.slice(0);var x=0,v=["#4FB3CF","#FDB924"],b=[],M=[];if(r.forEach(function(t){b.push(t[c]/t[l])}),i.forEach(function(t){M.push(t[_]/t[l])}),"in"===c.substring(3)){var _=c.substring(0,3)+"dto",w=d3.scale.linear().domain([Math.min.apply(Math,d),Math.max.apply(Math,d)]).range(["#f7f7f7",v[1]]),k=Math.max.apply(Math,b);x=1085}else"out"===c.substring(3)?(_=c.substring(0,3)+"otd",w=d3.scale.linear().domain([Math.min.apply(Math,d),Math.max.apply(Math,d)]).range(["#f7f7f7",v[0]]),k=Math.max.apply(Math,b),x=1085):(_=c.substring(0,3)+"onet",w=d3.scale.linear().domain([Math.min.apply(Math,d),0,Math.max.apply(Math,d)]).range([v[0],"#f7f7f7",v[1]]),k=Math.max.apply(Math,b)+Math.abs(Math.min.apply(Math,b)),x=1110+Math.abs(Math.min.apply(Math,b))/k*210,length=210);t.domain(new_id_list),I.transition().duration(500).attr("y",function(e,a){return 60+t(e.iata)}),I.on("click",function(t,e){triggertransition(t,0,c,l,x,k,w)}),B.on("click",function(t,e){triggertransition(t,0,c,l,x,k,w)}),E.on("click",function(t,e){triggertransition(t,0,c,l,x,k,w)}),S.on("click",function(t,e){triggertransition(t,0,c,l,x,k,w)}),S.transition().attr("r",function(t){return 2==e?2e3*Math.sqrt(Math.abs(t[c]/t[l]))/18:Math.sqrt(Math.abs(t[c]/t[l]))/18}).attr("fill",function(t){return w(t[c]/t[l])}),B.transition().duration(500).attr("fill",function(t,e){return w(t[c]/t[l])}).attr("x",function(t,e){return t[c]>=0?x:x-Math.abs(t[c]/t[l])/k*length}).attr("width",function(t,e){return Math.abs(t[c]/t[l])/k*length}).attr("y",function(e,a){return 52+t(e.iata)}),E.transition().duration(500).attr("x",function(t,e){return t[c]>=0?x+5+t[c]/t[l]/k*length:x-5+t[c]/t[l]/k*length}).text(function(t,a){return 2==e?Math.round(t[c]/t[l]*1e5)/100+"‰":toCommas(t[c]/t[l])}).attr("text-anchor",function(t,e){return t[c]>=0?"start":"end"}).attr("y",function(e,a){return 60+t(e.iata)})}(l,u,d)}),setSelectedIndex(document.getElementById("direction"),direction[1]),setSelectedIndex(document.getElementById("type"),type[1]),setSelectedIndex(document.getElementById("category"),category[1]);var T=function arctransition(t){t.transition().duration(function(t,e){return 500}).attrTween("stroke-dasharray",q).each("end",function(t,e){})},q=function tweetDash(){var t=this.getTotalLength();return d3.interpolateString("0,"+t,t+","+t)}})})}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})}}();