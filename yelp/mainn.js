function getColor(e){return e>1e3?"#084594":e>500?"#2171b5":e>200?"#4292c6":e>100?"#6baed6":e>50?"#9ecae1":e>20?"#c6dbef":e>10?"#deebf7":"#f7fbff"}function style(e){return{weight:2,opacity:1,color:"white",fillOpacity:.7,fillColor:getColor(e.properties.RCOUNT+e.properties.NCOUNT)}}function lightFeature(e){var o=e.target;o.setStyle({weight:2.5,color:"#666"}),L.Browser.ie||L.Browser.opera||o.bringToFront(),info.update(o.feature.properties)}function setHighlight(e){geojson.resetStyle(e.target),info.update()}function zmToFeature(e){map.fitBounds(e.target.getBounds())}function EachFeature(e,o){o.on({mouseover:lightFeature,mouseout:setHighlight,click:zmToFeature})}function update(){for(var e={},o=0;o<checkboxes.length;o++)checkboxes[o].checked&&(e[checkboxes[o].id]=!0);featureLayer.setFilter(function(o){return o.properties.SUBCATEGOR in e}).eachLayer(function(e){var o=types.indexOf(e.toGeoJSON().properties.SUBCATEGOR);e.bindPopup("<strong>"+e.toGeoJSON().properties.NAME.replace(/<br>/g,"")+"<br />Rating: "+e.toGeoJSON().properties.RATING+"<br />Review No.: "+e.toGeoJSON().properties.REVIEWNUM+"<br />Tel: "+e.toGeoJSON().properties.PHONE+"</strong>"),e.setIcon(L.mapbox.marker.icon({"marker-color":colors[o%12],"marker-size":"medium"}))}),featureLayer.on("mouseover",function(e){e.layer.openPopup()}),featureLayer.on("mouseout",function(e){e.layer.closePopup()})}function lightFeat(e){var o=e.target;o.setStyle({weight:2.5,color:"#666"}),L.Browser.ie||L.Browser.opera||o.bringToFront()}function setHigh(e){geojson.resetStyle(e.target)}function zmToFeat(e){map.fitBounds(e.target.getBounds())}function highlightFeature(e){var o=e.target;o.setStyle({stroke:!0,weight:1,color:"#666"}),L.Browser.ie||L.Browser.opera||o.bringToFront(),infooo.update(o.feature.properties)}function resetHighlight(e){geojsonLayer.resetStyle(e.target),infooo.update()}function onEachFeature(e,o){o.on({mouseover:highlightFeature,mouseout:resetHighlight})}L.mapbox.accessToken="pk.eyJ1IjoieGN6aGFvIiwiYSI6Ik41U2ptc2MifQ.ebOrer0bcIeHd3FB9jfUUQ";var map=L.map("map",{zoomControl:!1}).setView([40.7,-73.9],11),layer=L.mapbox.tileLayer("xczhao.l3034l31",{maxZoom:20,minZoom:10}).addTo(map);navigator.geolocation.getCurrentPosition(function(e){console.log(e);var o=[e.coords.longitude,e.coords.latitude],t={type:"Feature",properties:{"marker-color":"#ef8a62","marker-size":"medium","marker-symbol":"circle"},geometry:{type:"Point",coordinates:o}};L.geoJson(t,{pointToLayer:L.mapbox.marker.style,style:function(e){return e.properties}}).addTo(map),o[0]>-74.3&&o[0]<-73.65&&o[1]<40.95&&o[1]>40.45&&map.panTo(new L.LatLng(o[1],o[0]))});var info=L.control({position:"topright"});info.onAdd=function(e){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},info.update=function(e){this._div.innerHTML="<h4>New York City Neighborhood</h4>"+(e?"<b>"+e.NTANAME+"</b><br><b>"+e.RCOUNT+" Restaurants</b><br><b>"+e.NCOUNT+" Nightlife Spots</b>":"Hover over or click a neighborhood")};var infooo=L.control({position:"topright"});infooo.onAdd=function(e){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},infooo.update=function(e){this._div.innerHTML="<h4>Venue in Neighborhood</h4>"+(e?"<b>"+e.NAME+"</b><br><b>Category: "+e.SUBCATEGOR.replace("_","-")+"</b><br><b>Rating: "+e.RATING+"</b><br><b>Phone: "+e.PHONE:"Hover over a venue")},infooo.addTo(map);var geojson;geojson=L.geoJson(manhattan,{style:style,onEachFeature:EachFeature}).addTo(map);var colors=["#fdbf6f","#fb9a99","#b15928","#33a02c","#1f78b4","#e31a1c","#ff7f00","#b2df8a","#cab2d6","#6a3d9a","#ffff99","#a6cee3"],category=[];for(var i in yelpdata.features){var term=yelpdata.features[i].properties.SUBCATEGOR;category.indexOf(yelpdata.features[i].properties.SUBCATEGOR)>-1||category.push(yelpdata.features[i].properties.SUBCATEGOR)}category=category.sort();var match={};for(var i in category)match[category[i]]=colors[i%12];var featureLayer=L.mapbox.featureLayer(yelpdata,{}).setFilter(function(){return!1}).addTo(map),filters=document.getElementById("filters"),typesObj={},types=[],features=featureLayer.getGeoJSON().features;for(i=0;i<features.length;i++)null!=features[i].properties.SUBCATEGOR&&(typesObj[features[i].properties.SUBCATEGOR]=!0);(label=(item=filters.appendChild(document.createElement("div"))).appendChild(document.createElement("label"))).innerHTML="<strong>Select Categories</strong>";for(var k in typesObj)types.push(k);var checkboxes=[];types=types.sort();for(i=0;i<types.length;i++){var item,checkbox=(item=filters.appendChild(document.createElement("div"))).appendChild(document.createElement("input")),label=item.appendChild(document.createElement("label"));checkbox.type="checkbox",checkbox.id=types[i],checkbox.checked=!1,label.innerHTML=types[i].replace(/_/g,"-"),label.setAttribute("for",types[i]),checkbox.addEventListener("change",update),checkboxes.push(checkbox)}map.attributionControl.addAttribution('Data &copy; <a href="http://www.yelp.com/">Yelp</a>, <a href="http://www.nyc.gov/html/dcp/html/bytes/applbyte.shtml">NYCPLANNING</a>');var legend=L.control({position:"bottomright"});legend.onAdd=function(e){for(var o,t,r=L.DomUtil.create("div","info legend"),a=[0,10,20,50,100,200,500,1e3],i=["<strong>Venues Count</strong>"],n=0;n<a.length;n++)o=a[n],t=a[n+1],i.push('<i style="background:'+getColor(o+1)+'"></i> '+o+(t?"&ndash;"+t:"+"));return r.innerHTML=i.join("<br>"),r},legend.addTo(map),info.addTo(map),map.removeLayer(featureLayer),infooo.removeFrom(map),filters.style.display="none",map.on("zoomend",function(){map.getZoom()>=13&&map.hasLayer(geojson)&&(map.removeLayer(geojson),map.addLayer(featureLayer),legend.removeFrom(map),info.removeFrom(map),filters.style.display="block"),map.getZoom()<13&&map.hasLayer(featureLayer)&&(map.removeLayer(featureLayer),map.addLayer(geojson),legend.addTo(map),info.addTo(map),filters.style.display="none")});