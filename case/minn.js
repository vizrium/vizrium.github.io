function setSelectedIndex(t,e){for(i=0;i<t.options.length;i++)if(t.options[i].value==e){t.options[i].selected=!0;break}}function update(t){svg.selectAll(".bar").transition().attr("width",0),svg.selectAll(".bartext").transition().text(),svg.select("text.d").transition().attr("opacity",0),svg.select("text.c").transition().attr("opacity",0),d3.csv(t+".csv",function(e,r){r.forEach(function(t){t.date=parseDate(t.date),t.csindex=+Math.round(100*t.csindex)/100});var l=[],a={name:"Select City"};l.push(a);for(var i=0;i<names.length;i++){(a={}).name=names[i],l.push(a)}d3.select("#citymenu").selectAll("option").data(l).enter().append("option").transition().text(function(t){return t.name}),x.domain(d3.extent(r,function(t){return t.date})),"Prices"===t&&y.domain([d3.min(r,function(t){return t.csindex})-60,d3.max(r,function(t){return t.csindex})+60]),"Prices to Rents"===t&&y.domain([d3.min(r,function(t){return t.csindex})-45,d3.max(r,function(t){return t.csindex})+45]),"Prices to Income"===t&&y.domain([d3.min(r,function(t){return t.csindex})-50,d3.max(r,function(t){return t.csindex})+60]),svg.append("g").transition().duration(300).attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),svg.append("g").transition().duration(300).attr("class","y axis").call(yAxis),svg.append("text").transition().duration(300).attr("class","xlabel").attr("text-anchor","end").attr("x",width).attr("y",height-6).text("Year");var n=d3.nest().key(function(t){return t.city.replace(/ /g,"")}).entries(r);n.forEach(function(t,e){svg.append("path").attr("class",function(){return"line "+t.key}).attr("id",function(){return"line"+t.key}).attr("d",valueline(t.values)).style("opacity",function(){return"US"==t.key?1:0}).attr("stroke",function(){return"US"==t.key?colors[2]:colors[3]})});var c={};n.forEach(function(t,e){c[t.key]=[];var r=t.key,l=[];t.values.forEach(function(t,e){l.push(t),c[r]=l.slice(0)})});var o=0;for(ix in c){var s=c[ix][c[ix].length-1];s.csindex>o&&(o=s.csindex)}var d={},u={},p={},f={},g=0,h=0,v=0,m=100,_=0;for(ix in c){d[ix]=[],u[ix]=[],f[ix]=0,p[ix]=0;var b=0,A=100,k=0,w=0;for(i=0;i<c[ix].length;i++){if(0==i)u[ix].push(0);else{var S=c[ix][i].csindex-c[ix][i-1].csindex;u[ix].push(Math.round(S/c[ix][i-1].csindex*100*10)/10)}if(i<12)d[ix].push(0);else{S=c[ix][i].csindex-c[ix][i-12].csindex;d[ix].push(Math.round(S/c[ix][i-12].csindex*100*10)/10)}c[ix][i].csindex>b&&(b=c[ix][i].csindex),c[ix][i].csindex<A&&(A=c[ix][i].csindex)}k=Math.max(Math.max.apply(Math,d[ix]),-Math.min.apply(Math,d[ix])),w=Math.max(Math.max.apply(Math,u[ix]),-Math.min.apply(Math,u[ix])),f[ix]=A,p[ix]=b,current_distance=b-A,k>g&&(g=k),w>h&&(h=w),b>v&&(v=b),A<m&&(m=A),current_distance>_&&(_=current_distance)}current_data=c.US.slice(0),current_term="US";var U=[],M=[];current_data.forEach(function(t,e){for(e=0;e<notations.length;e++)t.date.getFullYear()===notations[e].date.getFullYear()&&t.date.getMonth()===notations[e].date.getMonth()&&(U.push(y(t.csindex)),M.push(x(t.date)))});var T=[80,350,40,390,0,150,410],F=[],E=[340,160,300,20,140,190,190],I=[20,10,20,-5,40,20,15],Y=notations.slice(0,7);"Prices to Income"==t&&(Y=notations.slice(0,6),T=[80,380,40,410,0,150]),svg.selectAll("notations").data(Y).enter().append("foreignObject").attr("id","notations").attr("x",function(t,e){return F.push(x(t.date)),x(t.date)-E[e]}).attr("y",function(t,e){return T[e]}).attr("width",180).attr("height",200).append("xhtml:span").style("font-weight","lighter").html(function(t){return"<font color = '#bdbdbd'>"+t.notext+"</font>"});var z=[0,1,2,4,5,6],B=[160,20,140,0,20,20];"Prices to Income"==t&&(z=z.slice(0,6));for(i=0;i<z.length;i++)svg.append("line").attr("id","notationlines").style("stroke","#969696").style("stroke-width",1).style("opacity",.5).attr("x1",M[z[i]]).attr("x2",M[z[i]]-B[i]).attr("y1",T[z[i]]+I[z[i]]).attr("y2",T[z[i]]+I[z[i]]);for(i=0;i<Y.length;i++)svg.append("line").attr("id","notationlines").style("stroke","#969696").style("stroke-width",1).style("opacity",.5).attr("x1",M[i]).attr("x2",M[i]).attr("y1",T[i]+I[i]).attr("y2",U[i]);d3.selectAll("#notations").moveToFront();var P=svg.append("g").style("display","none"),C=d3.bisector(function(t){return t.date}).left;P.append("line").attr("class","x").style("stroke",currrent_color).style("stroke-width",2).style("stroke-dasharray","5,5").style("opacity",1).attr("y1",0).attr("y2",130),P.append("text").attr("class","a").style("font-size",16).attr("fill",colors[2]).style("stroke",colors[2]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(o)-10).style("text-anchor","end").attr("opacity",1),P.append("text").attr("class","b").style("font-size",16).attr("fill",colors[2]).style("stroke",colors[2]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(o)-30).style("text-anchor","end").attr("opacity",1).text(current_term),svg.append("text").attr("class","e").style("font-size",16).attr("fill",colors[2]).style("stroke",colors[2]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(o)-10).style("text-anchor","end").attr("opacity",0),svg.append("rect").attr("width",width).attr("height",height).style("fill","none").style("pointer-events","all").on("mouseover",function(){P.style("display",null)}).on("mouseout",function(){P.style("display","none"),svg.selectAll(".bar").transition().attr("x",fix_xlocation).attr("width",0),svg.selectAll(".bartext").transition().attr("x",fix_xlocation).style("text-anchor","end").text()}).on("mousemove",function mousemove(){var t=x.invert(d3.mouse(this)[0]),e=C(current_data,t,1),l=r[e-1],a=r[e];l.date,a.date,P.select("line.x").attr("transform","translate("+x(current_data[e].date)+","+y(current_data[e].csindex)+")").attr("y2",height-y(current_data[e].csindex)),P.select("text.a").text(function(){return formatTime(current_data[e].date)}),P.select("text.b").transition().text(function(){return current_data[e].city}),P.select("text.a").transition().text(function(){return formatTime(current_data[e].date)}),svg.selectAll(".bar").filter(".b0").transition().attr("width",(current_data[e].csindex-f[current_data[e].city.replace(/ /g,"")])/_*150).attr("x",fix_xlocation-(current_data[e].csindex-f[current_data[e].city.replace(/ /g,"")])/_*150),svg.selectAll(".bartext").filter(".lb0").transition().text("+"+Math.round((current_data[e].csindex-f[current_data[e].city.replace(/ /g,"")])/f[current_data[e].city.replace(/ /g,"")]*100*1)/1+"%").attr("x",fix_xlocation-(current_data[e].csindex-f[current_data[e].city.replace(/ /g,"")])/_*150),svg.selectAll(".bar").filter(".b1").transition().attr("width",(p[current_data[e].city.replace(/ /g,"")]-current_data[e].csindex)/_*150).attr("x",fix_xlocation-(p[current_data[e].city.replace(/ /g,"")]-current_data[e].csindex)/_*150),svg.selectAll(".bartext").filter(".lb1").transition().text("-"+Math.round((p[current_data[e].city.replace(/ /g,"")]-current_data[e].csindex)/p[current_data[e].city.replace(/ /g,"")]*100*1)/1+"%").attr("x",fix_xlocation-(p[current_data[e].city.replace(/ /g,"")]-current_data[e].csindex)/_*150);var i=c[current_data[e].city.replace(/ /g,"")].indexOf(current_data[e]);u[current_data[e].city.replace(/ /g,"")][i]>=0?(svg.selectAll(".bar").filter(".b2").transition().attr("fill",colors[1]).attr("width",u[current_data[e].city.replace(/ /g,"")][i]/g*150).attr("x",fix_xlocation-u[current_data[e].city.replace(/ /g,"")][i]/g*150),svg.selectAll(".bartext").filter(".lb2").transition().attr("fill",colors[1]).style("stroke",colors[1]).text("+"+u[current_data[e].city.replace(/ /g,"")][i]+"%").attr("x",fix_xlocation-u[current_data[e].city.replace(/ /g,"")][i]/g*150)):(svg.selectAll(".bar").filter(".b2").transition().attr("fill",colors[0]).attr("width",-u[current_data[e].city.replace(/ /g,"")][i]/g*150).attr("x",fix_xlocation+u[current_data[e].city.replace(/ /g,"")][i]/g*150),svg.selectAll(".bartext").filter(".lb2").transition().attr("fill",colors[0]).style("stroke",colors[0]).text(u[current_data[e].city.replace(/ /g,"")][i]+"%").attr("x",fix_xlocation+u[current_data[e].city.replace(/ /g,"")][i]/g*150)),d[current_data[e].city.replace(/ /g,"")][i]>=0?(svg.selectAll(".bar").filter(".b3").transition().attr("fill",colors[1]).attr("width",d[current_data[e].city.replace(/ /g,"")][i]/g*150).attr("x",fix_xlocation-d[current_data[e].city.replace(/ /g,"")][i]/g*150),svg.selectAll(".bartext").filter(".lb3").transition().attr("fill",colors[1]).style("stroke",colors[1]).text("+"+d[current_data[e].city.replace(/ /g,"")][i]+"%").attr("x",fix_xlocation-d[current_data[e].city.replace(/ /g,"")][i]/g*150)):(svg.selectAll(".bar").filter(".b3").transition().attr("fill",colors[0]).attr("width",-d[current_data[e].city.replace(/ /g,"")][i]/g*150).attr("x",fix_xlocation+d[current_data[e].city.replace(/ /g,"")][i]/g*150),svg.selectAll(".bartext").filter(".lb3").transition().attr("fill",colors[0]).style("stroke",colors[0]).text(d[current_data[e].city.replace(/ /g,"")][i]+"%").attr("x",fix_xlocation+d[current_data[e].city.replace(/ /g,"")][i]/g*150))}),svg.append("text").attr("class","c").style("font-size",16).attr("fill",colors[3]).style("stroke",colors[3]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(o)-10).style("text-anchor","end").attr("opacity",0),svg.append("text").attr("class","d").style("font-size",16).attr("fill",colors[3]).style("stroke",colors[3]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(o)-30).style("text-anchor","end").attr("opacity",0),alldot=svg.selectAll("dot").data(r).enter().append("circle").attr("r",2.5).style("cursor","pointer").attr("class",function(t,e){return"dot "+t.city.replace(/ /g,"")}).attr("id",function(t,e){return"dot"+t.city.replace(/ /g,"")}).attr("cx",function(t){return x(t.date)}).attr("cy",function(t){return y(t.csindex)}).attr("fill",function(t,e){return"US"==t.city?colors[2]:"#ccc"}).on("mouseover",function(t){d3.select(this).transition().attr("stroke",colors[3]).attr("fill",colors[3]),svg.select("text.d").transition().attr("opacity",1).text(function(){return t.city}),svg.select("text.c").transition().attr("opacity",1).text(function(){return formatTime(t.date)}),svg.selectAll(".bar").filter(".b0").transition().attr("width",(t.csindex-f[t.city.replace(/ /g,"")])/_*150).attr("x",fix_xlocation-(t.csindex-f[t.city.replace(/ /g,"")])/_*150),svg.selectAll(".bartext").filter(".lb0").transition().text("+"+Math.round((t.csindex-f[t.city.replace(/ /g,"")])/f[t.city.replace(/ /g,"")]*100*1)/1+"%").attr("x",fix_xlocation-(t.csindex-f[t.city.replace(/ /g,"")])/_*150),svg.selectAll(".bar").filter(".b1").transition().attr("width",(p[t.city.replace(/ /g,"")]-t.csindex)/_*150).attr("x",fix_xlocation-(p[t.city.replace(/ /g,"")]-t.csindex)/_*150),svg.selectAll(".bartext").filter(".lb1").transition().text("-"+Math.round((p[t.city.replace(/ /g,"")]-t.csindex)/p[t.city.replace(/ /g,"")]*100*1)/1+"%").attr("x",fix_xlocation-(p[t.city.replace(/ /g,"")]-t.csindex)/_*150);var e=c[t.city.replace(/ /g,"")].indexOf(t);u[t.city.replace(/ /g,"")][e]>=0?(svg.selectAll(".bar").filter(".b2").transition().attr("fill",colors[1]).attr("width",u[t.city.replace(/ /g,"")][e]/g*150).attr("x",fix_xlocation-u[t.city.replace(/ /g,"")][e]/g*150),svg.selectAll(".bartext").filter(".lb2").transition().attr("fill",colors[1]).style("stroke",colors[1]).text("+"+u[t.city.replace(/ /g,"")][e]+"%").attr("x",fix_xlocation-u[t.city.replace(/ /g,"")][e]/g*150)):(svg.selectAll(".bar").filter(".b2").transition().attr("fill",colors[0]).attr("width",-u[t.city.replace(/ /g,"")][e]/g*150).attr("x",fix_xlocation+u[t.city.replace(/ /g,"")][e]/g*150),svg.selectAll(".bartext").filter(".lb2").transition().attr("fill",colors[0]).style("stroke",colors[0]).text(u[t.city.replace(/ /g,"")][e]+"%").attr("x",fix_xlocation+u[t.city.replace(/ /g,"")][e]/g*150)),d[t.city.replace(/ /g,"")][e]>=0?(svg.selectAll(".bar").filter(".b3").transition().attr("fill",colors[1]).attr("width",d[t.city.replace(/ /g,"")][e]/g*150).attr("x",fix_xlocation-d[t.city.replace(/ /g,"")][e]/g*150),svg.selectAll(".bartext").filter(".lb3").transition().attr("fill",colors[1]).style("stroke",colors[1]).text("+"+d[t.city.replace(/ /g,"")][e]+"%").attr("x",fix_xlocation-d[t.city.replace(/ /g,"")][e]/g*150)):(svg.selectAll(".bar").filter(".b3").transition().attr("fill",colors[0]).attr("width",-d[t.city.replace(/ /g,"")][e]/g*150).attr("x",fix_xlocation+d[t.city.replace(/ /g,"")][e]/g*150),svg.selectAll(".bartext").filter(".lb3").transition().attr("fill",colors[0]).style("stroke",colors[0]).text(d[t.city.replace(/ /g,"")][e]+"%").attr("x",fix_xlocation+d[t.city.replace(/ /g,"")][e]/g*150))}).on("mouseout",function(t){svg.selectAll(".bar").transition().attr("x",fix_xlocation).attr("width",0),svg.selectAll(".bartext").transition().attr("x",fix_xlocation).style("text-anchor","end").text(),svg.select("text.d").transition().attr("opacity",0),svg.select("text.c").transition().attr("opacity",0),"US"==t.city?d3.select(this).transition().attr("stroke","none").attr("fill",colors[2]):1==d3.selectAll("#line"+t.city.replace(/ /g,"")).style("opacity")?d3.select(this).transition().attr("stroke","none").attr("fill",colors[3]):d3.select(this).transition().attr("stroke","none").attr("fill","#ccc")}).on("click",function(t){if("US"!=t.city&&0==d3.select("#line"+t.city.replace(/ /g,"")).style("opacity")){d3.selectAll(".line").transition().style("opacity",0),d3.selectAll(".dot").transition().attr("fill","#ccc"),d3.selectAll("#lineUS").transition().style("opacity",1),d3.selectAll("#dotUS").transition().attr("fill",colors[2]),d3.selectAll("#lineUS").moveToFront(),d3.selectAll("#dotUS").moveToFront(),d3.selectAll("#legend").transition().style("opacity",1),d3.selectAll("#legend").style("fill",colors[3]).attr("stroke",colors[3]);d3.select("#line"+t.city.replace(/ /g,"")).style("stroke");d3.selectAll("#line"+t.city.replace(/ /g,"")).transition().style("opacity",1),d3.selectAll("#dot"+t.city.replace(/ /g,"")).transition().attr("fill",colors[3]),d3.select("line.x").transition().style("stroke",colors[3]),d3.select("text.a").transition().style("stroke",colors[3]).style("fill",colors[3]),d3.select("text.b").transition().style("stroke",colors[3]).style("fill",colors[3]).text(t.city),current_data=c[t.city.replace(/ /g,"")].slice(0),current_term=t.city,setSelectedIndex(document.getElementById("citymenu"),t.city);d3.selectAll("#line"+t.city.replace(/ /g,"")).moveToFront();d3.selectAll("#dot"+t.city.replace(/ /g,"")).moveToFront()}}),d3.selectAll("#lineUS").moveToFront(),d3.selectAll("#dotUS").moveToFront(),svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),document.getElementById("citymenu").onchange=function(){var t=this.value.replace(/ /g,"");try{if(0==d3.select("#line"+t).style("opacity")){d3.selectAll(".line").transition().style("opacity",0),d3.selectAll(".dot").transition().attr("fill","#ccc"),d3.selectAll("#lineUS").transition().style("opacity",1),d3.selectAll("#dotUS").transition().attr("fill",colors[2]),d3.selectAll("#legend").transition().style("opacity",1),d3.selectAll("#legend").style("fill",colors[3]).attr("stroke",colors[3]);d3.selectAll("#US").moveToFront();d3.selectAll("#dotUS").moveToFront(),d3.selectAll("#line"+t).transition().style("opacity",1),d3.selectAll("#dot"+t).transition().attr("fill",colors[3]),d3.select("line.x").transition().style("stroke",colors[3]),d3.select("text.a").transition().style("stroke",colors[3]).style("fill",colors[3]),d3.select("text.b").transition().style("stroke",colors[3]).style("fill",colors[3]).text(this.value),current_data=c[this.value.replace(/ /g,"")].slice(0),current_term=this.value;d3.selectAll("#line"+t).moveToFront();d3.selectAll("#dot"+t).moveToFront()}}catch(e){if("SelectCity"==t){d3.selectAll(".line").transition().style("opacity",0),d3.selectAll(".dot").transition().attr("fill","#ccc"),d3.selectAll("#lineUS").transition().style("opacity",1),d3.selectAll("#dotUS").transition().attr("fill",colors[2]),d3.selectAll("#legend").transition().style("opacity",0),d3.select("line.x").transition().style("stroke",colors[2]),d3.select("text.a").transition().style("stroke",colors[2]).style("fill",colors[2]),d3.select("text.b").transition().style("stroke",colors[2]).style("fill",colors[2]).text("US"),current_data=c.US.slice(0),current_term="US";d3.selectAll("#US").moveToFront();d3.selectAll("#dotUS").moveToFront()}}}})}d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var margin={top:25,right:5,bottom:20,left:30},width=960-margin.left-margin.right,height=500-margin.top-margin.bottom,parseDate=d3.time.format("%b , %Y").parse,formatTime=d3.time.format("%b %Y"),x=d3.time.scale().range([0,width]),y=d3.scale.linear().range([height,0]),colors=["#66c2a5","#e78ac3","#8da0cb","#fc8d62"],xAxis=d3.svg.axis().scale(x).orient("bottom").ticks(10),yAxis=d3.svg.axis().scale(y).orient("left").ticks(5),valueline=d3.svg.line().x(function(t){return x(t.date)}).y(function(t){return y(t.csindex)}),notations=[{date:"09/17/2005",notext:"Federal Reserve Board Chairman Alan Greenspan admits to their being “a little froth” observed in the housing market"},{date:"09/15/2008",notext:"Lehman Brothers files for bankruptcy protection"},{date:"10/03/2008",notext:"The Emergency Economic Stabilization Act is passed bailing out the US financial system"},{date:"03/09/2009",notext:"Dow Jones hits lowest point in twelve years"},{date:"06/01/2009",notext:"The US Bureau of Economic Research announces that the Great Recession is over"},{date:"11/21/2012",notext:" Average US interest rate for 30-Yr FRM drops to 3.31% - the lowest point ever"},{date:"10/29/2014",notext:"Fed announces the end of qualitative easing measures in US"}],no_parse=d3.time.format("%m/%d/%Y").parse,no_format=d3.time.format("%b %Y");notations.forEach(function(t,e){t.date=no_parse(t.date)});var div=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),svg=d3.select("body").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),indexoptions=[{name:"Prices"},{name:"Prices to Rents"},{name:"Prices to Income"}],indexmenu=d3.select("#indexmenu");indexmenu.selectAll("option").data(indexoptions).enter().append("option").text(function(t){return t.name});var indexterm="Prices",currrent_color=colors[2];d3.csv(indexterm+".csv",function(t,e){names=[],e.forEach(function(t){t.date=parseDate(t.date),t.csindex=+Math.round(100*t.csindex)/100,-1==names.indexOf(t.city)&&names.push(t.city)}),names.pop(),color=d3.scale.category20b().domain(names);var r=[],l={name:"Select City"};r.push(l);for(var a=0;a<names.length;a++){(l={}).name=names[a],r.push(l)}d3.select("#citymenu").selectAll("option").data(r).enter().append("option").transition().text(function(t){return t.name}),x.domain(d3.extent(e,function(t){return t.date})),y.domain([d3.min(e,function(t){return t.csindex})-60,d3.max(e,function(t){return t.csindex})+60]);var i=d3.nest().key(function(t){return t.city.replace(/ /g,"")}).entries(e);i.forEach(function(t,e){svg.append("path").attr("class",function(){return"line "+t.key}).attr("id",function(){return"line"+t.key}).attr("d",valueline(t.values)).style("opacity",function(){return"US"==t.key?1:0}).attr("stroke",function(){return"US"==t.key?colors[2]:colors[3]})});var n={};i.forEach(function(t,e){n[t.key]=[];var r=t.key,l=[];t.values.forEach(function(t,e){l.push(t),n[r]=l.slice(0)})});var c=0;for(ix in n){var o=n[ix][n[ix].length-1];o.csindex>c&&(c=o.csindex)}var s={},d={},u={},p={},f=0,g=0,h=0,v=100,m=0;for(ix in n){s[ix]=[],d[ix]=[],p[ix]=0,u[ix]=0;var _=0,b=100,A=0,k=0;for(a=0;a<n[ix].length;a++){if(0==a)d[ix].push(0);else{var w=n[ix][a].csindex-n[ix][a-1].csindex;d[ix].push(Math.round(w/n[ix][a-1].csindex*100*10)/10)}if(a<12)s[ix].push(0);else{w=n[ix][a].csindex-n[ix][a-12].csindex;s[ix].push(Math.round(w/n[ix][a-12].csindex*100*10)/10)}n[ix][a].csindex>_&&(_=n[ix][a].csindex),n[ix][a].csindex<b&&(b=n[ix][a].csindex)}A=Math.max(Math.max.apply(Math,s[ix]),-Math.min.apply(Math,s[ix])),k=Math.max(Math.max.apply(Math,d[ix]),-Math.min.apply(Math,d[ix])),p[ix]=b,u[ix]=_,current_distance=_-b,A>f&&(f=A),k>g&&(g=k),_>h&&(h=_),b<v&&(v=b),current_distance>m&&(m=current_distance)}current_data=n.US.slice(0),current_term="US";var S=[],U=[];current_data.forEach(function(t,e){for(e=0;e<notations.length;e++)t.date.getFullYear()===notations[e].date.getFullYear()&&t.date.getMonth()===notations[e].date.getMonth()&&(S.push(y(t.csindex)),U.push(x(t.date)))});var M=notations.slice(0,7),T=[80,350,40,390,0,150,410],F=[],E=[340,160,300,20,140,190,190],I=[20,10,20,-5,40,20,15];svg.selectAll("notations").data(M).enter().append("foreignObject").attr("id","notations").attr("x",function(t,e){return F.push(x(t.date)),x(t.date)-E[e]}).attr("y",function(t,e){return T[e]}).attr("width",180).attr("height",200).append("xhtml:span").style("font-weight","lighter").html(function(t){return"<font color = '#bdbdbd'>"+t.notext+"</font>"});var Y=[0,1,2,4,5,6],z=[160,20,140,0,20,20];for(a=0;a<Y.length;a++)svg.append("line").attr("id","notationlines").style("stroke","#969696").style("stroke-width",1).style("opacity",.5).attr("x1",U[Y[a]]).attr("x2",U[Y[a]]-z[a]).attr("y1",T[Y[a]]+I[Y[a]]).attr("y2",T[Y[a]]+I[Y[a]]);for(a=0;a<notations.length;a++)svg.append("line").attr("id","notationlines").style("stroke","#969696").style("stroke-width",1).style("opacity",.5).attr("x1",U[a]).attr("x2",U[a]).attr("y1",T[a]+I[a]).attr("y2",S[a]);d3.selectAll("#notations").moveToFront();var B=svg.append("g").style("display","none"),P=d3.bisector(function(t){return t.date}).left;B.append("line").attr("class","x").style("stroke",currrent_color).style("stroke-width",2).style("stroke-dasharray","5,5").style("opacity",1).attr("y1",0).attr("y2",130),B.append("text").attr("class","a").style("font-size",16).attr("fill",colors[2]).style("stroke",colors[2]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(c)-10).style("text-anchor","end").attr("opacity",1),B.append("text").attr("class","b").style("font-size",16).attr("fill",colors[2]).style("stroke",colors[2]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(c)-30).style("text-anchor","end").attr("opacity",1).text(current_term),svg.append("text").attr("class","c").style("font-size",16).attr("fill",colors[3]).style("stroke",colors[3]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(c)-10).style("text-anchor","end").attr("opacity",0),svg.append("text").attr("class","d").style("font-size",16).attr("fill",colors[3]).style("stroke",colors[3]).style("stroke-width",1).attr("x",x(current_data[current_data.length-1].date)).attr("y",y(c)-30).style("text-anchor","end").attr("opacity",0);var C=["YoY","MoM","&#x0394 High","&#x0394 Low"];C=C.reverse().slice(0);for(a=0;a<C.length;a++)svg.append("text").attr("x",x(current_data[current_data.length-1].date)).attr("y",y(c)-70-30*a).style("text-anchor","end").html(C[a]),svg.append("rect").attr("class","bar b"+a).attr("fill",colors[1]).attr("x",x(current_data[170].date)).attr("width",0).attr("y",y(c)-85-30*a).attr("height",20),svg.append("text").attr("class","bartext lb"+a).attr("fill",colors[1]).style("font-size",16).style("stroke",colors[1]).style("stroke-width",1).style("text-anchor","end").attr("x",x(current_data[170].date)).attr("y",y(c)-70-30*a).text("");svg.selectAll(".bar").filter(".b1").transition().attr("fill",colors[0]),svg.selectAll(".bartext").filter(".lb1").transition().attr("fill",colors[0]).style("stroke",colors[0]),fix_xlocation=x(current_data[170].date),svg.append("rect").attr("width",width).attr("height",height).style("fill","none").style("pointer-events","all").on("mouseover",function(){B.style("display",null)}).on("mouseout",function(){B.style("display","none"),svg.selectAll(".bar").transition().attr("x",fix_xlocation).attr("width",0),svg.selectAll(".bartext").transition().attr("x",fix_xlocation).style("text-anchor","end").text()}).on("mousemove",function mousemove(){var t=x.invert(d3.mouse(this)[0]),r=P(current_data,t,1),l=e[r-1],a=e[r];l.date,a.date,B.select("line.x").attr("transform","translate("+x(current_data[r].date)+","+y(current_data[r].csindex)+")").attr("y2",height-y(current_data[r].csindex)),B.select("text.a").text(function(){return formatTime(current_data[r].date)}),B.select("text.b").transition().text(function(){return current_data[r].city}),B.select("text.a").transition().text(function(){return formatTime(current_data[r].date)}),svg.selectAll(".bar").filter(".b0").transition().attr("width",(current_data[r].csindex-p[current_data[r].city.replace(/ /g,"")])/m*150).attr("x",fix_xlocation-(current_data[r].csindex-p[current_data[r].city.replace(/ /g,"")])/m*150),svg.selectAll(".bartext").filter(".lb0").transition().text("+"+Math.round((current_data[r].csindex-p[current_data[r].city.replace(/ /g,"")])/p[current_data[r].city.replace(/ /g,"")]*100*1)/1+"%").attr("x",fix_xlocation-(current_data[r].csindex-p[current_data[r].city.replace(/ /g,"")])/m*150),svg.selectAll(".bar").filter(".b1").transition().attr("width",(u[current_data[r].city.replace(/ /g,"")]-current_data[r].csindex)/m*150).attr("x",fix_xlocation-(u[current_data[r].city.replace(/ /g,"")]-current_data[r].csindex)/m*150),svg.selectAll(".bartext").filter(".lb1").transition().text("-"+Math.round((u[current_data[r].city.replace(/ /g,"")]-current_data[r].csindex)/u[current_data[r].city.replace(/ /g,"")]*100*1)/1+"%").attr("x",fix_xlocation-(u[current_data[r].city.replace(/ /g,"")]-current_data[r].csindex)/m*150);var i=n[current_data[r].city.replace(/ /g,"")].indexOf(current_data[r]);d[current_data[r].city.replace(/ /g,"")][i]>=0?(svg.selectAll(".bar").filter(".b2").transition().attr("fill",colors[1]).attr("width",d[current_data[r].city.replace(/ /g,"")][i]/f*150).attr("x",fix_xlocation-d[current_data[r].city.replace(/ /g,"")][i]/f*150),svg.selectAll(".bartext").filter(".lb2").transition().attr("fill",colors[1]).style("stroke",colors[1]).text("+"+d[current_data[r].city.replace(/ /g,"")][i]+"%").attr("x",fix_xlocation-d[current_data[r].city.replace(/ /g,"")][i]/f*150)):(svg.selectAll(".bar").filter(".b2").transition().attr("fill",colors[0]).attr("width",-d[current_data[r].city.replace(/ /g,"")][i]/f*150).attr("x",fix_xlocation+d[current_data[r].city.replace(/ /g,"")][i]/f*150),svg.selectAll(".bartext").filter(".lb2").transition().attr("fill",colors[0]).style("stroke",colors[0]).text(d[current_data[r].city.replace(/ /g,"")][i]+"%").attr("x",fix_xlocation+d[current_data[r].city.replace(/ /g,"")][i]/f*150)),s[current_data[r].city.replace(/ /g,"")][i]>=0?(svg.selectAll(".bar").filter(".b3").transition().attr("fill",colors[1]).attr("width",s[current_data[r].city.replace(/ /g,"")][i]/f*150).attr("x",fix_xlocation-s[current_data[r].city.replace(/ /g,"")][i]/f*150),svg.selectAll(".bartext").filter(".lb3").transition().attr("fill",colors[1]).style("stroke",colors[1]).text("+"+s[current_data[r].city.replace(/ /g,"")][i]+"%").attr("x",fix_xlocation-s[current_data[r].city.replace(/ /g,"")][i]/f*150)):(svg.selectAll(".bar").filter(".b3").transition().attr("fill",colors[0]).attr("width",-s[current_data[r].city.replace(/ /g,"")][i]/f*150).attr("x",fix_xlocation+s[current_data[r].city.replace(/ /g,"")][i]/f*150),svg.selectAll(".bartext").filter(".lb3").transition().attr("fill",colors[0]).style("stroke",colors[0]).text(s[current_data[r].city.replace(/ /g,"")][i]+"%").attr("x",fix_xlocation+s[current_data[r].city.replace(/ /g,"")][i]/f*150))}),alldot=svg.selectAll("dot").data(e).enter().append("circle").attr("r",2.5).style("cursor","pointer").attr("class",function(t,e){return"dot "+t.city.replace(/ /g,"")}).attr("id",function(t,e){return"dot"+t.city.replace(/ /g,"")}).attr("cx",function(t){return x(t.date)}).attr("cy",function(t){return y(t.csindex)}).attr("fill",function(t,e){return"US"==t.city?colors[2]:"#ccc"}).on("mouseover",function(t){d3.select(this).transition().attr("stroke",colors[3]).attr("fill",colors[3]),svg.select("text.d").transition().attr("opacity",1).text(function(){return t.city}),svg.select("text.c").transition().attr("opacity",1).text(function(){return formatTime(t.date)}),svg.selectAll(".bar").filter(".b0").transition().attr("width",(t.csindex-p[t.city.replace(/ /g,"")])/m*150).attr("x",fix_xlocation-(t.csindex-p[t.city.replace(/ /g,"")])/m*150),svg.selectAll(".bartext").filter(".lb0").transition().text("+"+Math.round((t.csindex-p[t.city.replace(/ /g,"")])/p[t.city.replace(/ /g,"")]*100*1)/1+"%").attr("x",fix_xlocation-(t.csindex-p[t.city.replace(/ /g,"")])/m*150),svg.selectAll(".bar").filter(".b1").transition().attr("width",(u[t.city.replace(/ /g,"")]-t.csindex)/m*150).attr("x",fix_xlocation-(u[t.city.replace(/ /g,"")]-t.csindex)/m*150),svg.selectAll(".bartext").filter(".lb1").transition().text("-"+Math.round((u[t.city.replace(/ /g,"")]-t.csindex)/u[t.city.replace(/ /g,"")]*100*1)/1+"%").attr("x",fix_xlocation-(u[t.city.replace(/ /g,"")]-t.csindex)/m*150);var e=n[t.city.replace(/ /g,"")].indexOf(t);d[t.city.replace(/ /g,"")][e]>=0?(svg.selectAll(".bar").filter(".b2").transition().attr("fill",colors[1]).attr("width",d[t.city.replace(/ /g,"")][e]/f*150).attr("x",fix_xlocation-d[t.city.replace(/ /g,"")][e]/f*150),svg.selectAll(".bartext").filter(".lb2").transition().attr("fill",colors[1]).style("stroke",colors[1]).text("+"+d[t.city.replace(/ /g,"")][e]+"%").attr("x",fix_xlocation-d[t.city.replace(/ /g,"")][e]/f*150)):(svg.selectAll(".bar").filter(".b2").transition().attr("fill",colors[0]).attr("width",-d[t.city.replace(/ /g,"")][e]/f*150).attr("x",fix_xlocation+d[t.city.replace(/ /g,"")][e]/f*150),svg.selectAll(".bartext").filter(".lb2").transition().attr("fill",colors[0]).style("stroke",colors[0]).text(d[t.city.replace(/ /g,"")][e]+"%").attr("x",fix_xlocation+d[t.city.replace(/ /g,"")][e]/f*150)),s[t.city.replace(/ /g,"")][e]>=0?(svg.selectAll(".bar").filter(".b3").transition().attr("fill",colors[1]).attr("width",s[t.city.replace(/ /g,"")][e]/f*150).attr("x",fix_xlocation-s[t.city.replace(/ /g,"")][e]/f*150),svg.selectAll(".bartext").filter(".lb3").transition().attr("fill",colors[1]).style("stroke",colors[1]).text("+"+s[t.city.replace(/ /g,"")][e]+"%").attr("x",fix_xlocation-s[t.city.replace(/ /g,"")][e]/f*150)):(svg.selectAll(".bar").filter(".b3").transition().attr("fill",colors[0]).attr("width",-s[t.city.replace(/ /g,"")][e]/f*150).attr("x",fix_xlocation+s[t.city.replace(/ /g,"")][e]/f*150),svg.selectAll(".bartext").filter(".lb3").transition().attr("fill",colors[0]).style("stroke",colors[0]).text(s[t.city.replace(/ /g,"")][e]+"%").attr("x",fix_xlocation+s[t.city.replace(/ /g,"")][e]/f*150))}).on("mouseout",function(t){svg.selectAll(".bar").transition().attr("x",x(current_data[170].date)).attr("width",0),svg.selectAll(".bartext").transition().attr("x",x(current_data[170].date)).style("text-anchor","end").text(),svg.select("text.d").transition().attr("opacity",0),svg.select("text.c").transition().attr("opacity",0),"US"==t.city?d3.select(this).transition().attr("stroke","none").attr("fill",colors[2]):1==d3.selectAll("#line"+t.city.replace(/ /g,"")).style("opacity")?d3.select(this).transition().attr("stroke","none").attr("fill",colors[3]):d3.select(this).transition().attr("stroke","none").attr("fill","#ccc")}).on("click",function(t){if("US"!=t.city&&0==d3.select("#line"+t.city.replace(/ /g,"")).style("opacity")){d3.selectAll(".line").transition().style("opacity",0),d3.selectAll(".dot").transition().attr("fill","#ccc"),d3.selectAll("#lineUS").transition().style("opacity",1),d3.selectAll("#dotUS").transition().attr("fill",colors[2]),d3.selectAll("#lineUS").moveToFront(),d3.selectAll("#dotUS").moveToFront(),d3.selectAll("#legend").transition().style("opacity",1),d3.selectAll("#legend").style("fill",colors[3]).attr("stroke",colors[3]);d3.select("#line"+t.city.replace(/ /g,"")).style("stroke");d3.selectAll("#line"+t.city.replace(/ /g,"")).transition().style("opacity",1),d3.selectAll("#dot"+t.city.replace(/ /g,"")).transition().attr("fill",colors[3]),d3.select("line.x").transition().style("stroke",colors[3]),d3.select("text.a").transition().style("stroke",colors[3]).style("fill",colors[3]),d3.select("text.b").transition().style("stroke",colors[3]).style("fill",colors[3]).text(t.city),current_data=n[t.city.replace(/ /g,"")].slice(0),current_term=t.city,setSelectedIndex(document.getElementById("citymenu"),t.city);d3.selectAll("#line"+t.city.replace(/ /g,"")).moveToFront();d3.selectAll("#dot"+t.city.replace(/ /g,"")).moveToFront()}}),d3.selectAll("#lineUS").moveToFront(),d3.selectAll("#dotUS").moveToFront(),svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),svg.append("g").attr("class","y axis").call(yAxis),document.getElementById("citymenu").onchange=function(){var t=this.value.replace(/ /g,"");try{if(0==d3.select("#line"+t).style("opacity")){d3.selectAll(".line").transition().style("opacity",0),d3.selectAll(".dot").transition().attr("fill","#ccc"),d3.selectAll("#lineUS").transition().style("opacity",1),d3.selectAll("#dotUS").transition().attr("fill",colors[2]),d3.selectAll("#legend").transition().style("opacity",1),d3.selectAll("#legend").style("fill",colors[3]).attr("stroke",colors[3]);d3.selectAll("#US").moveToFront();d3.selectAll("#dotUS").moveToFront(),d3.selectAll("#line"+t).transition().style("opacity",1),d3.selectAll("#dot"+t).transition().attr("fill",colors[3]),d3.select("line.x").transition().style("stroke",colors[3]),d3.select("text.a").transition().style("stroke",colors[3]).style("fill",colors[3]),d3.select("text.b").transition().style("stroke",colors[3]).style("fill",colors[3]).text(this.value),current_data=n[this.value.replace(/ /g,"")].slice(0),current_term=this.value;d3.selectAll("#line"+t).moveToFront();d3.selectAll("#dot"+t).moveToFront()}}catch(e){if("SelectCity"==t){d3.selectAll(".line").transition().style("opacity",0),d3.selectAll(".dot").transition().attr("fill","#ccc"),d3.selectAll("#lineUS").transition().style("opacity",1),d3.selectAll("#dotUS").transition().attr("fill",colors[2]),d3.selectAll("#legend").transition().style("opacity",0),d3.select("line.x").transition().style("stroke",colors[2]),d3.select("text.a").transition().style("stroke",colors[2]).style("fill",colors[2]),d3.select("text.b").transition().style("stroke",colors[2]).style("fill",colors[2]).text("US"),current_data=n.US.slice(0),current_term="US";d3.selectAll("#US").moveToFront();d3.selectAll("#dotUS").moveToFront()}}},svg.append("text").attr("class","xlabel").attr("text-anchor","end").attr("x",width).attr("y",height-6).text("Year")}),document.getElementById("indexmenu").onchange=function(){d3.selectAll("#notations").remove(),d3.selectAll("#notationlines").remove(),d3.selectAll("#legend").transition().style("opacity",0),d3.selectAll(".line").remove(),d3.selectAll("line.x").remove(),d3.selectAll(".dot").remove(),d3.selectAll(".axis").remove(),setSelectedIndex(document.getElementById("citymenu"),"Select City"),svg.select("text.b").remove(),svg.select("text.a").remove(),svg.select("text.d").remove(),svg.select("text.c").remove(),svg.select("text.ylabel").remove(),svg.select("text.xlabel").remove();update(this.value)};